---
title: "Démarche"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=F, warning=F, fig.align = "center",  dev='svg')
library(plyr)
library(lattice)
library(lubridate)
library(svglite)

#loading relevant packages
library(zoo) #for rollmean function
library(tidyr)
library(tidyverse) #mainly for reading files functions
library(dplyr)
library(ggplot2) #for ggplot graphs
library(cowplot) #for plot_grid()
library(stringr) #to manipulate strings

theme_set(
  theme_classic() +
  theme(legend.position = "none", 
        legend.title = element_blank(),
        panel.grid.major.y = element_line(),
        text = element_text(family = "Times New Roman"),
        plot.title = element_text(face="bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())
  )
g_theme <- scale_color_manual(values=c('#ff0000','#D8D8D8'))
myred <- '#ff0000'
mygrey <- '#b4b4b4'
#height and width of graphs
w <- 4.5
h <- 5.2

size_adimssion <- .4
alpha_admission <- .3
```

```{r loading true data, echo=FALSE, message=FALSE, warning=FALSE}
# IF NO INTERNET CONNECTION OR LINK BROKEN, UNCOMMENT BELOW TO LOAD LOCAL DATA
data_gouv_new_hosp_rea <-
  read.csv(url("https://www.data.gouv.fr/fr/datasets/r/6fadff46-9efd-4c53-942a-54aca783c30c"), sep=";") %>%
  mutate(date = as.Date(jour))
data_gouv_beds_hosp_rea <-
  read.csv(url("https://www.data.gouv.fr/fr/datasets/r/63352e38-d353-4b54-bfd1-f1b3ee1cabd7"), sep=";")  %>%
  mutate(date = as.Date(jour))

#TO UNCOMMENT
# local_file_path <- "data/0_real_data_back_up/" # local file path
# data_gouv_new_hosp_rea <- read.csv2(paste0(local_file_path, "covid-hospit-incid-2023-03-31-18h01.csv"), sep = ";") %>%
#   mutate(date = as.Date(jour))
# data_gouv_beds_hosp_rea <- read.csv2(paste0(local_file_path, "covid-hospit-2023-03-31-18h01.csv"), sep = ";") %>%
#   mutate(date = as.Date(jour))

#Lits occupés en réanimation, hospitalisation et hospitalisation conventionnelle
true_data_beds_hosp_rea <- data_gouv_beds_hosp_rea %>%
  filter(sexe =="0", # 0 = hommes + femmes, 1=hommes, 2=femmes
         #enlève l'Outre-Mer car les scénarios de Pasteur uniquement pour la France Métropolitaine
         dep != 971 & dep != 972 & dep != 973 & dep != 974 & dep != 976 & dep != 978) %>%
  group_by(date) %>% #grouper tous les départements ensembles
  dplyr::summarise(hosp = sum(hosp, na.rm = T), 
            rea = sum(rea, na.rm = T),
            HospConv = sum(HospConv, na.rm = T))

#pour les echos pasteur 29 avril ile de france
true_data_beds_hosp_rea_IDF <- data_gouv_beds_hosp_rea %>%
  filter(sexe =="0", # 0 = hommes + femmes, 1=hommes, 2=femmes
         #enlève l'Outre-Mer car les scénarios de Pasteur uniquement pour la France Métropolitaine
         dep == 75 | dep == 92 | dep == 93 | dep == 94 | dep == 91 | dep == 95 | dep == 78 | dep == 77) %>% 
  group_by(date) %>% #grouper tous les départements ensembles
  dplyr::summarise(hosp = sum(hosp, na.rm = T), 
            rea = sum(rea, na.rm = T),
            HospConv = sum(HospConv, na.rm = T))

#Nouvelles admissions à l'hôpital et en réanimation (moyenné sur 7 jours)
true_data_new_hosp_rea <- data_gouv_new_hosp_rea %>% 
  filter( #enlève l'Outre-Mer car les scénarios de Pasteur uniquement pour la France Métropolitaine
         dep != 971 & dep != 972 & dep != 973 & dep != 974 & dep != 976 & dep != 978) %>% 
  group_by(date) %>% #grouper tous les départements ensembles
  dplyr::summarise(incid_hosp = sum(incid_hosp, na.rm = T), 
            incid_rea = sum(incid_rea, na.rm = T)) %>%
  mutate(new_rea_right = rollmean(incid_rea, 7, na.pad = T, align = "right"),#mean of 7 last days
         new_hosp_right = rollmean(incid_hosp, 7, na.pad = T, align = "right"),
         new_rea_center = rollmean(incid_rea, 7, na.pad = T, align = "center"),#centered mean
         new_hosp_center = rollmean(incid_hosp, 7, na.pad = T, align = "center"))

true_data_new_hosp_rea_no_mean <- data_gouv_new_hosp_rea %>% 
  filter( #enlève l'Outre-Mer car les scénarios de Pasteur uniquement pour la France Métropolitaine
    dep != 971 & dep != 972 & dep != 973 & dep != 974 & dep != 976 & dep != 978) %>% 
  group_by(date) %>% #grouper tous les départements ensembles
  dplyr::summarise(new_hosp = sum(incid_hosp, na.rm = T), 
            new_rea = sum(incid_rea, na.rm = T))

#Pour l'INSERM : admissions hebdomadaire à l'hôpital
true_data_new_hosp_rea_weekly <- data_gouv_new_hosp_rea %>% 
  group_by(date) %>% #je n'ai pas filtré les outre-mer ici car pas précisé, mais ne change pas grand-chose
  dplyr::summarise(incid_hosp = sum(incid_hosp, na.rm = T)) %>%
  mutate(new_hosp_week = rollsum(incid_hosp, 7, na.pad = T, align = "left")) #patients arrivés dans les 7 derniers jours)

```

```{r f_graph}
f_graph <- 
  function(
    true_data, scenarios, 
    variable, date_adjust, value_adjust,
    x_label_realite, y_label_realite,
    x_label_scenario, y_label_scenario,
    x_label_publication, y_label_publication,
    x_min, x_max, y_max,
    str_title, str_subtitle
  ){
    scenarios %>%
      gather(key=pasteur, value = value, -date) %>%
      ggplot(
        aes(
          date+date_adjust, value+value_adjust, 
          group=pasteur, color="scénarios"
          )
        ) + 
      geom_smooth(se=F) + 
      geom_line(
        data= true_data, 
        aes(
          x=date, y=!!as.symbol(variable), 
          color = "réalité", group="réalité"
          ),
        size = 1
        ) +
      annotate(
        'text', x = as.Date(x_label_realite), y = y_label_realite, label = "réalité", 
        color = myred, fontface = "bold", family = "Times New Roman"
        ) + 
      annotate(
        'text', x = as.Date(x_label_scenario), y = y_label_scenario, label = "scénarios", 
        color = mygrey, fontface = "bold", family = "Times New Roman"
        ) + 
      geom_vline(
        xintercept = as.Date(x_label_publication), linetype="dashed"
      ) +
      annotate(
        'text', x = as.Date(x_label_publication)-1, y = y_label_publication, label = "date de\npublication", 
        color = "black", fontface = "italic", family = "Times New Roman", hjust=1
      ) +
      xlim(date(x_min), date(x_max)) + ylim(0, y_max) + g_theme +
      labs(
        title = str_title,
        subtitle = str_subtitle,
        caption = "\ntwitter : @Covid_Scenarios"
        )
  }
```


# Notre démarche

Ce site vise à proposer une rétrospective sur les principaux scénarios de modélisation utilisés pour guider les décisions majeures prises depuis deux ans (par exemple confinements, couvre-feu, ou encore mise en place du pass sanitaire). Une description détaillée des scénarios de modélisations est accessible sur la page [Accueil](https://evaluation-modelisation-covid.github.io/france/). Une explication de l'importance de l'évaluation des scénarios de modélisation est accessible sur la page [Impact](https://evaluation-modelisation-covid.github.io/france/impact).

# Pourquoi évaluer les scénarios de modélisation est-il important?

Les scénarios de modélisation jouent un rôle primordial dans les politiques publiques mises en place depuis le début de la pandémie de covid-19. Par conséquent, pour pouvoir prendre de bonnes décisions, il est important d'avoir des scénarios de modélisation qui permettent de bien anticiper la réalité.

Par exemple, ce sont des [scénarios de modélisation](https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/covid-19/report-9-impact-of-npis-on-covid-19/) qui ont conduit beaucoup de gouvernement à ne pas se limiter aux mesures traditionnelles de lutte contre les épidémies pour aller vers un confinement strict. En effet, [le rapport de l'OMS](https://www.who.int/publications/i/item/non-pharmaceutical-public-health-measuresfor-mitigating-the-risk-and-impact-of-epidemic-and-pandemic-influenza) de préparation aux pandémies de 2019 ne recommandait sous aucune circonstance la fermeture des frontières, le contact tracing ou la quarantaine des cas contact durant la phase pandémique (et a fortiori encore moins un confinement généralisé).

Ainsi, dans son [rapport du 12 mars 2020](https://solidarites-sante.gouv.fr/IMG/pdf/avis_conseil_scientifique_12_mars_2020.pdf), le Conseil Scientifique a affirmé que les mesures classiques utilisées pour limiter la propagation des épidémies ne permettraient pas de limiter suffisamment la circulation du virus, impliquant la nécessité d'un confinement strict ("on ne s'attend pas à ce que la réduction de la taille du pic épidémique soit suffisante pour éviter une saturation du système de santé. (...) Cette intuition a été illustrée à travers la réalisation d'un modèle COVID19 particulier (Neil Ferguson, communication personnelle)."), en se basant sur le modèle dont les résultats sont présentés ci-dessous.


```{r Sweden_Imperial_ICU_peak, echo=FALSE, out.width="500px"}
knitr::include_graphics("images/Imperial_Sweden/Sweden_icu.svg")
```

Les scénarios du modèle sont représentés par les barres grises, représentant 2 extrêmes : un confinement stric tel que suivi par les autres pays européens, et aucune mesure. L'approche suivie par la Suède est intérmédiaire, quelque part entre les deux.

On voit que les scénarios ont largement surestimé la taille du pic hospitalier : même le scénario optimiste avec un confinement strict surestime ce pic par un facteur 2, alors même que la Suède n'a pas confiné sa population.

Cet exemple illustre l'importance que peuvent avoir les scénarios de modélisation, par exemple en décidant un gouvernement à mettre en place un confinement strict.

# Peut-on vraiment les évaluer?

Un argument souvent entendu au sujet des scénarios de modélisation est le suivant: comme le scénario permet d'anticiper le pire, il mène à prendre des mesures qui vont justement empêcher que le scénario modélisé se produisent, ce qui explique le décalage entre le scénario de modélisation et la réalité (où des mesures de freinage ont été prises!). Effectivement, il n'est pas possible d'établir une comparaison dans ce cas de figure.

<center>

![](images/pas_de_comparaison.png){width="500px"}

</center>

Cependant, les scénarios de modélisation intègrent souvent plusieurs hypothèses sur les mesures de freinage qui pourraient être mises en place. Ici, nous ne comparerons la réalité qu'**avec des scénarios où les mesures de freinage mises en place avaient aussi été modélisées**.

<center>

![](images/comparaison_explication.png){width="500px"}

</center>

Ainsi, la comparaison entre scénarios de modélisation et réalité permettra bien d'évaluer si ceux-ci ont bien anticipé la réalité.

Par exemple, lors de la 4ème vague, l'Institut Pasteur avait d'abord publié un rapport le 9 juillet. Après l'annonce de l'extension du pass sanitaire annoncée mi-juillet, l'Institut Pasteur a publié un nouveau rapport intégrant l'effet de cette mesure, le 26 juillet, puis encore un le 6 août. Comparer les modélisations du rapport du 9 juillet avec la réalité n'est pas légitime, mais comparer les prévisions des rapports suivants avec la réalité oui (car l'impact des mesures y a déja été modélisé).

## {.tabset .tabset-fade .tabset-pills}

### Lits de soins critiques

```{r fig.show='animate', animation.hook='gifski', dev='png'}
# 26 juillet
scenario <- read.csv("data/2021_07_26_Pasteur/beds_SC.csv", sep=";") %>%
  mutate(date = as.Date(date, format = "%d/%m/%Y", optional = T))

f_graph(
  true_data_beds_hosp_rea, scenario, 
  "rea", 0, 0,
  "2021-08-30", 1000, #réalité label
  "2021-08-25", 9500, #scénarios label
  "2021-07-26", 6000, #date de publication label
  "2021-07-15", "2021-10-01", 12500, #limites
  "Lits de soins critiques", 
  "scénarios publiés par l'Institut Pasteur le 26 juillet 2021\n"
) 

# 5 aout
scenario <- read.csv("data/2021_08_05_Pasteur/beds_SC.csv", sep=";") %>%
  mutate(date = as.Date(date, format = "%d/%m/%Y", optional = T))

f_graph(
  true_data_beds_hosp_rea, scenario, 
  "rea", 0, 0,
  "2021-08-30", 1000, #réalité label
  "2021-08-20", 5800, #scénarios label
  "2021-08-05", 6000, #date de publication label
  "2021-07-15", "2021-10-01", 12500, #limites
  "Lits de soins critiques", 
  "scénarios publiés par l'Institut Pasteur le 5 août 2021\n"
) 
```

### Admissions en soins critiques

```{r fig.show='animate', animation.hook='gifski', dev='png'}
# 26 juillet
scenario <- read.csv("data/2021_07_26_Pasteur/new_SC.csv", sep=";") %>%
  mutate(date = as.Date(date, format = "%d/%m/%Y", optional = T))

f_graph(
  true_data_new_hosp_rea, scenario, 
  "new_rea_center", 0, 0,
  "2021-08-19", 70, #réalité label
  "2021-08-15", 800, #scénarios label
  "2021-07-26", 600, #date de publication label
  "2021-07-15", "2021-10-01", 900, #limites
  "Admissions en soins critiques", 
  "scénarios publiés par l'Institut Pasteur le 26 juillet 2021\n"
) +
  geom_line(
    data= true_data_new_hosp_rea_no_mean, 
    aes(
      x=date, y=new_rea, 
      color = "réalité", group="réalité"
      ),
    size = size_adimssion, alpha=alpha_admission
    ) 


# 5 août
scenario <- read.csv("data/2021_08_05_Pasteur/new_SC.csv", sep=";") %>%
  mutate(date = as.Date(date, format = "%d/%m/%Y", optional = T))

f_graph(
  true_data_new_hosp_rea, scenario, 
  "new_rea_center", 0, 0,
  "2021-08-19", 70, #réalité label
  "2021-09-01", 610, #scénarios label
  "2021-08-05", 600, #date de publication label
  "2021-07-15", "2021-10-01", 900, #limites
  "Admissions en soins critiques", 
  "scénarios publiés par l'Institut Pasteur le 5 août 2021\n"
) +
  geom_line(
    data= true_data_new_hosp_rea_no_mean, 
    aes(
      x=date, y=new_rea, 
      color = "réalité", group="réalité"
      ),
    size = size_adimssion, alpha=alpha_admission
    ) 
```

### Admissions à l'hôpital

```{r fig.show='animate', animation.hook='gifski', dev='png'}
#N 26 juillet
scenario <- read.csv("data/2021_07_26_Pasteur/new_hospital.csv", sep=";") %>%
  mutate(date = as.Date(date, format = "%d/%m/%Y", optional = T))

f_graph(
  true_data_new_hosp_rea, scenario, 
  "new_hosp_center", 0, 0,
  "2021-08-15", 350, #réalité label
  "2021-08-15", 3200, #scénarios label
  "2021-07-26", 2500, #date de publication label
  "2021-07-15", "2021-10-01", 4100, #limites
  "Admissions à l'hôpital",
  "scénarios publiés par l'Institut Pasteur le 26 juillet 2021\n"
) +
  geom_line(
    data= true_data_new_hosp_rea_no_mean, 
    aes(
      x=date, y=new_hosp, 
      color = "réalité", group="réalité"
      ),
    size = size_adimssion, alpha=alpha_admission
    ) 

# 5 août
scenario <- read.csv("data/2021_08_05_Pasteur/new_hosp.csv", sep=";") %>%
  mutate(date = as.Date(date, format = "%d/%m/%Y", optional = T))

f_graph(
  true_data_new_hosp_rea, scenario, 
  "new_hosp_center", 0, 0,
  "2021-08-15", 350, #réalité label
  "2021-08-13", 1900, #scénarios label
  "2021-08-05", 2500, #date de publication label
  "2021-07-15", "2021-10-01", 4100, #limites
  "Admissions à l'hôpital",
  "scénarios publiés par l'Institut Pasteur le 5 août 2021\n"
) +
  geom_line(
    data= true_data_new_hosp_rea_no_mean, 
    aes(
      x=date, y=new_hosp, 
      color = "réalité", group="réalité"
      ),
    size = size_adimssion, alpha=alpha_admission
    ) 
```

##

Ces scénarios comparent les prévisions faites pour le mois d'août 2021 avec l'évolution réelle durant les mois d'août: comme les scénarios intègrent les mesures mises en place, la comparaison est possible.

# Est-ce vraiment grave si les modélisations ne concordent pas avec la réalité?

On peut penser qu'il vaut mieux surestimer la réalité et "prévoir systématiquement le pire", et donc mener les politiques à réagir avec un surplus de mesures pour limiter la propagation de l'épidémie. En réalité, la plupart des mesures de freinage de l'épidémie (confinement, couvre-feu, fermeture de classes, fermetures de lieux publics) ont des impacts sanitaires, sociaux et économiques négatifs. Par conséquent, surréagir face à l'épidémie n'est pas une bonne chose (de même que ne pas réagir assez).

<center>

![](images/explication_simulation_enjeu.png){width="500px"}

</center>

Des modélisations trop pessimistes peuvent ainsi conduire à maintenir en place des mesures restrictives qui ne seraient pas nécessaires. Par exemple, lorsque le [gouvernement britannique a décidé de lever la plupart de ses mesures de restrictions](https://news.sky.com/story/covid-19-what-are-the-remaining-rules-in-england-after-freedom-day-12359221) (telles que limitations de capacité dans les lieux accueillant du public, port du masque obligatoire ou encore limitations de déplacement) le 19 juillet 2021, sans non plus mettre en place un "pass sanitaire" pour accéder à des évenements ou lieux publics, [cette initiative a été décriée par des scientifiques comme "dangereuse et prématurée"](https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(21)01589-0/fulltext). Cette thèse de l'ouverture "dangereuse et prématurée" était [supportée par les modélisations du conseil scientifique Britannique (SAGE)](https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/1001169/S1301_SPI-M-O_Summary_Roadmap_second_Step_4.2__1_.pdf), représentées ci-dessous.

<center>

![](images/sage_scenarios.png){width="500"}

</center>

Ces modélisations étaient largement pessimistes, et ont donc surestimée la nécessité de maintenir en place des mesures restrictives. Des modélisations non alignées avec la réalité ont donc failli empêcher un retour à une vie presque normale pour les Britanniques.

Une description plus détaillée des scénarios de modélisation est accessible sur la page [Modélisations](https://evaluation-modelisation-covid.github.io/france/).
